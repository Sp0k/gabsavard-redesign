---
import matter from "gray-matter";
import { Marked } from "marked";
import markedFootnote from "marked-footnote";
import { supabase } from "../../db/supabase";
import BaseLayout from "../../layouts/BaseLayout.astro";

export const prerender = false;

const slugParts = Astro.params.slug;
const slug = Array.isArray(slugParts) ? slugParts.join("/") : slugParts;

const candidates = [`published/${slug}.md`, `published/${slug}/index.md`];

function isRelativeUrl(href: unknown): href is string {
  return (
    typeof href === "string" &&
    !href.startsWith("http://") &&
    !href.startsWith("https://") &&
    !href.startsWith("data:") &&
    !href.startsWith("/") &&
    !href.startsWith("#")
  );
}

const assetsBase = `${import.meta.env.SUPABASE_URL}/storage/v1/object/public/blog-assets/${slug}/`;

function toSupabaseAssetUrl(src: string): string {
  if (
    src.startsWith("http://") ||
    src.startsWith("https://") ||
    src.startsWith("data:") ||
    src.startsWith("#")
  ) {
    return src;
  }

  if (src.startsWith("/pictures/posts/")) {
    const rest = src.replace(/^\/pictures\/posts\//, ""); // <folder>/file.jpg
    return `${import.meta.env.SUPABASE_URL}/storage/v1/object/public/blog-assets/${rest}`;
  }

  if (src.startsWith("/")) return src;

  const clean = src.replace(/^\.?\//, "");
  return assetsBase + clean;
}

let html = "";
let title = "Post not found";
let dateText = "";

for (const path of candidates) {
  const { data: urlData } = supabase.storage.from("blog-posts").getPublicUrl(path);

  const res = await fetch(urlData.publicUrl);
  if (!res.ok) continue;

  const mdText = await res.text();
  const parsed = matter(mdText);

  title = parsed.data?.title ?? slug;

  if (parsed.data?.date) {
    const d = new Date(String(parsed.data.date));
    dateText = d.toDateString().slice(4, 15);
  }

  let content = parsed.content ?? "";

  content = content.replace(
    /<img\b([^>]*?)\bsrc=(["'])([^"']+)\2/gi,
    (_match, before, quote, src) => {
      const newSrc = toSupabaseAssetUrl(String(src));
      return `<img${before} src=${quote}${newSrc}${quote}`;
    }
  );

  const md = new Marked();
  md.use(markedFootnote());

  // Keep your existing markdown-image rewrite (for ![]() syntax)
  md.use({
    walkTokens(token: any) {
      if (token.type === "image" && token.href && isRelativeUrl(token.href)) {
        token.href = toSupabaseAssetUrl(token.href);
      }
    },
  });

  html = await md.parse(content);
  break;
}

const notFound = !html;
if (notFound) Astro.response.status = 404;
---
<BaseLayout pageTitle={title}>
  <div class="mt-4">
    <div class="flex flex-col">
      <h1 class="text-4xl lg:text-5xl text-[#D9D9D9] font-semibold font-Nunito mb-2">{title}</h1>
      <p class="text-lg lg:text-xl text-[#D9D9D9] font-normal font-Source-Sans-Pro">published: <b class="text-lg lg:text-xl text-[#459DDE] font-normal font-Source-Sans-Pro">{dateText}</b></p>
      <hr class="bg-[#D9D9D9] border-none h-[1px] max-w-screen-xl mr-4 my-3">
    </div>
    <div class="max-w-screen-xl lg:mr-4 mb-4 prose
                prose-p:text-base lg:prose-p:text-lg prose-p:text-[#D9D9D9] prose-p:font-Source-Sans-Pro
                prose-a:text-[#459DDE] prose-a:no-underline prose-a:hover:underline prose-a:transition-all
                prose-h2:text-2xl lg:prose-h2:text-3xl prose-h2:mb-0 lg:prose-h2:mb-1 prose-h2:mt-8 prose-h2:text-[#D9D9D9] prose-h2:font-bold
                prose-code:bg-[#303030] prose-code:font-semibold prose-code:font-Nunito prose-code:text-pink-600
                prose-em:italic prose-em:text-[#D9D9D9] prose-em:font-bold
                prose-strong:text-[#D9D9D9] prose-strong:font-extrabold
                prose-pre:py-0 prose-pre:px-0 prose-pre:rounded-none
                prose-ol:text-base lg:prose-ol:text-lg prose-ol:text-[#D9D9D9] prose-ol:font-Source-Sans-Pro prose-ol:mx-8
                prose-ul:text-base lg:prose-ul:text-lg prose-ul:text-[#D9D9D9] prose-ul:font-Source-Sans-Pro prose-ul:mx-8
                prose-h3:text-xl lg:prose-h3:text-2xl prose-h3:text-[#D9D9D9] prose-h3:font-bold prose-h3:mb-0 lg:prose-h3:mb-1
                prose-th:text-[#D9D9D9] prose-th:text-sm lg:prose-th:text-xl prose-th:font-semibold
                prose-td:text-[#D9D9D9] prose-td:text-xs lg:prose-td:text-lg prose-td:font-normal
                prose-table:table-auto prose-table:max-w-screen-xl md:prose-table:min-w-[600px] prose-table:w-fit
                prose-blockquote:flex prose-blockquote:justify-center lg:prose-blockquote:mx-32 lg:prose-blockquote:my-12
                ">
{notFound ? <p>Post not found.</p> : <article set:html={html} />}
    </div>
  </div>
</BaseLayout>
