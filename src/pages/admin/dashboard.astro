---
import EmptyLayout from "../../layouts/EmptyLayout.astro";
import { Sidebar } from "../../components/admin/Sidebar/Sidebar";
import { AdminDashboard } from "../../components/admin/AdminDashboard/AdminDashboard";
import matter from "gray-matter"
import { supabase } from "../../db/supabase.server"
import { 
  BLOG_BUCKET,
  DRAFT_FOLDER,
  CONTACT_TABLE,
  PUBLISHED_FOLDER,
  DEVLOG_POSTS,
  DEVLOG_ASSETS,
  ASSETS_BUCKET,
} from "../../db/storage.constants";

export const prerender = false

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin/");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/admin/");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/admin/");
}

const pageTitle = "Admin Dashboard";

const [
  { data: pubData, error: pubError },
  { data: draftData, error: draftError },
  { data: devPubData, error: devPubError },
  { data: devDraftData, error: devDraftError },
] = await Promise.all([
    supabase.storage.from(BLOG_BUCKET).list(PUBLISHED_FOLDER, { limit: 200 }),
    supabase.storage.from(BLOG_BUCKET).list(DRAFT_FOLDER, { limit: 200 }),
    supabase.storage.from(DEVLOG_POSTS).list(PUBLISHED_FOLDER, { limit: 200 }),
    supabase.storage.from(DEVLOG_POSTS).list(DRAFT_FOLDER, { limit: 200 }),
  ]);

if (pubError) console.error(pubError);
if (draftError) console.error(draftError);
if (devPubError) console.error(devPubError);
if (devDraftError) console.error(devDraftError);

const publishedFiles = pubData ?? [];
const draftFiles = draftData ?? [];
const devPublishedFiles = devPubData ?? [];
const devDraftFiles = devDraftData ?? [];

type StorageListItem = {
  name: string;
  updated_at?: string | null;
  created_at?: string | null;
};

type PostStatus = "published" | "draft";

type PostType = "blog" | "devlog";

type ParsedPost = {
  slug: string;
  data: Record<string, any>;
  content: string;
  sortDate: number;
  status: PostStatus;
  type: PostType;
};

async function parseFiles(
  files: StorageListItem[],
  folder: string,
  status: PostStatus,
  opts: { postsBucket: string; assetsBucket: string; type: PostType }
): Promise<(ParsedPost | null)[]> {
  const { postsBucket, assetsBucket, type } = opts;
  return Promise.all(
    files
      .filter((f) => f.name.endsWith(".md"))
      .map(async (f): Promise<ParsedPost | null> => {
        const path = `${folder}/${f.name}`;

        let mdText = "";

        const { data: urlData } = supabase.storage.from(postsBucket).getPublicUrl(path);

        if (urlData?.publicUrl) {
          const r = await fetch(urlData.publicUrl);
          if (r.ok) mdText = await r.text();
        }

        if (!mdText) {
          const { data: blob, error } = await supabase.storage.from(postsBucket).download(path);
          if (error || !blob) {
            console.error(`Failed to read ${path}:`, error);
            return null;
          }
          mdText = await blob.text();
        }

        const parsed = matter(mdText);
        const slug = f.name.replace(/\.md$/i, "");

        const assetsBase = `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${assetsBucket}/${slug}/`;
        const src = (parsed.data as any)?.image?.url as string | undefined;

        if (
          src &&
            !src.startsWith("http://") &&
            !src.startsWith("https://") &&
            !src.startsWith("data:") &&
            !src.startsWith("#")
        ) {
          if (src.startsWith("/pictures/posts/")) {
            const rest = src.replace(/^\/pictures\/posts\//, "");
            (parsed.data as any).image.url =
              `${import.meta.env.PUBLIC_SUPABASE_URL}/storage/v1/object/public/${assetsBucket}/${rest}`;
          } else if (src.startsWith("/")) {
            // leave absolute site path alone
          } else {
            const clean = src.replace(/^\.?\//, "");
            (parsed.data as any).image.url = assetsBase + clean;
          }
        }

        const sortDate = (parsed.data as any)?.date
          ? Date.parse(String((parsed.data as any).date))
          : Date.parse(String(f.updated_at ?? f.created_at ?? ""));

        return {
          slug,
          data: (parsed.data ?? {}) as Record<string, any>,
          content: parsed.content ?? "",
          sortDate: Number.isFinite(sortDate) ? sortDate : 0,
          status,
          type,
        };
      })
  );
}

const [publishedPosts, draftPosts, devPublishedPosts, devDraftPosts] = await Promise.all([
  parseFiles(publishedFiles, PUBLISHED_FOLDER, "published", {
    postsBucket: BLOG_BUCKET,
    assetsBucket: ASSETS_BUCKET,
    type: "blog",
  }),
  parseFiles(draftFiles, DRAFT_FOLDER, "draft", {
    postsBucket: BLOG_BUCKET,
    assetsBucket: ASSETS_BUCKET,
    type: "blog",
  }),
  parseFiles(devPublishedFiles, PUBLISHED_FOLDER, "published", {
    postsBucket: DEVLOG_POSTS,
    assetsBucket: DEVLOG_ASSETS,
    type: "devlog",
  }),
  parseFiles(devDraftFiles, DRAFT_FOLDER, "draft", {
    postsBucket: DEVLOG_POSTS,
    assetsBucket: DEVLOG_ASSETS,
    type: "devlog",
  }),
]);

const posts = [...publishedPosts, ...draftPosts, ...devPublishedPosts, ...devDraftPosts].filter(Boolean);

posts.sort((a, b) => (b?.sortDate ?? 0) - (a?.sortDate ?? 0));

const { data, error } = await supabase.from(CONTACT_TABLE).select("*").order("created_at", { ascending: false });

const messages = error === null ? data : [];
const unreadMsgCount = messages.reduce((acc, m) => acc + (!m.seen ? 1 : 0), 0);
---
<EmptyLayout pageTitle={pageTitle} accessToken={accessToken} refreshToken={refreshToken} showNav={false}>
  <div class="bg-stone-100 h-full">
    <div class="grid gap-4 p-4 grid-cols-[220px_1fr]">
      <Sidebar page="dashboard" unreadMsgCount={unreadMsgCount} client:load />
      <AdminDashboard articles={posts} messages={messages} client:load />
    </div>
    <p class="mx-auto text-stone-400 w-fit text-sm pt-1.5 pb-3">
      Â© Copyright 2026. Made by Gab Savard.
    </p>
  </div>
</EmptyLayout>
