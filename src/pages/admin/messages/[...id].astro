---
export const prerender = false;

import EmptyLayout from "../../../layouts/EmptyLayout.astro";
import { Sidebar } from "../../../components/admin/Sidebar/Sidebar";
import { DisplayPage } from "../../../components/admin/Messages/DisplayPage";
import { supabase } from "../../../db/supabase.server";
import { CONTACT_TABLE } from "../../../db/storage.constants";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin/");
}

try {
  const session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete("sb-access-token", { path: "/" });
    Astro.cookies.delete("sb-refresh-token", { path: "/" });
    return Astro.redirect("/admin/");
  }
} catch {
  Astro.cookies.delete("sb-access-token", { path: "/" });
  Astro.cookies.delete("sb-refresh-token", { path: "/" });
  return Astro.redirect("/admin/");
}

const { count, error: countError } = await supabase
  .from(CONTACT_TABLE)
  .select("id", { count: "exact", head: true })
  .eq("seen", false);

const unreadMsgCount = countError ? 0 : (count ?? 0);

const { id } = Astro.params;
if (!id) {
  console.log("Id is missing");
  return Astro.redirect("/admin/dashboard");
}

const { data: msg, error: msgError } = await supabase
  .from(CONTACT_TABLE)
  .select("id,name,email,message,created_at,seen")
  .eq("id", id)
  .single();

if (msgError || !msg) {
  return Astro.redirect("/admin/dashboard");
}

if (!msg.seen) {
  await supabase
    .from(CONTACT_TABLE)
    .update({ seen: true })
    .eq("id", id);

  msg.seen = true;
}
---

<EmptyLayout pageTitle="Message" showNav={false}>
  <div class="bg-stone-100 h-full">
    <div class="grid gap-4 p-4 grid-cols-[220px_1fr]">
      <Sidebar page="messages" unreadMsgCount={unreadMsgCount} client:load />

      <div class="grid gap-4">
        <DisplayPage
          name={msg.name ?? "—"}
          email={msg.email}
          message={msg.message}
          createdAt={msg.created_at}
          client:load
        />
      </div>
    </div>

    <p class="mx-auto text-stone-400 w-fit text-sm pt-1.5 pb-3">
      © Copyright 2026. Made by Gab Savard.
    </p>
  </div>
</EmptyLayout>
