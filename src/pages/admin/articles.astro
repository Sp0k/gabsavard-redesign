---
import EmptyLayout from "../../layouts/EmptyLayout.astro";
import { Sidebar } from "../../components/admin/Sidebar/Sidebar";
import { ArticlesPage } from "../../components/admin/Articles/ArticlesPage";
import matter from "gray-matter"
import { supabase } from "../../db/supabase.server"
import { BLOG_BUCKET, CONTACT_TABLE, DRAFT_FOLDER, PUBLISHED_FOLDER } from "../../db/storage.constants";

export const prerender = false

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/admin/");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/admin/");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/admin/");
}

const pageTitle = "Articles";

const [{ data: pubData, error: pubError }, { data: draftData, error: draftError }] =
  await Promise.all([
    supabase.storage.from(BLOG_BUCKET).list(PUBLISHED_FOLDER, { limit: 200 }),
    supabase.storage.from(BLOG_BUCKET).list(DRAFT_FOLDER, { limit: 200 }),
  ]);

if (pubError) console.error(pubError);
if (draftError) console.error(draftError);

const publishedFiles = pubData ?? [];
const draftFiles = draftData ?? [];

type StorageListItem = {
  name: string;
  updated_at?: string | null;
  created_at?: string | null;
};

type PostStatus = "published" | "draft";

type ParsedPost = {
  slug: string;
  data: Record<string, any>;
  content: string;
  sortDate: number;
  status: PostStatus;
};

async function parseFiles(
  files: StorageListItem[],
  folder: string,
  status: PostStatus
): Promise<(ParsedPost | null)[]> {
  return Promise.all(
    files
      .filter((f) => f.name.endsWith(".md"))
      .map(async (f): Promise<ParsedPost | null> => {
        const path = `${folder}/${f.name}`;

        let mdText = "";

        const { data: urlData } = supabase.storage.from(BLOG_BUCKET).getPublicUrl(path);

        if (urlData?.publicUrl) {
          const r = await fetch(urlData.publicUrl);
          if (r.ok) mdText = await r.text();
        }

        if (!mdText) {
          const { data: blob, error } = await supabase.storage.from(BLOG_BUCKET).download(path);
          if (error || !blob) {
            console.error(`Failed to read ${path}:`, error);
            return null;
          }
          mdText = await blob.text();
        }

        const parsed = matter(mdText);
        const slug = f.name.replace(/\.md$/i, "");

        const assetsBase = `${import.meta.env.SUPABASE_URL}/storage/v1/object/public/blog-assets/${slug}/`;
        const src = (parsed.data as any)?.image?.url as string | undefined;

        if (
          src &&
          !src.startsWith("http://") &&
          !src.startsWith("https://") &&
          !src.startsWith("data:") &&
          !src.startsWith("#")
        ) {
          if (src.startsWith("/pictures/posts/")) {
            const rest = src.replace(/^\/pictures\/posts\//, "");
            (parsed.data as any).image.url =
              `${import.meta.env.SUPABASE_URL}/storage/v1/object/public/blog-assets/${rest}`;
          } else if (src.startsWith("/")) {
            // leave absolute site path alone
          } else {
            const clean = src.replace(/^\.?\//, "");
            (parsed.data as any).image.url = assetsBase + clean;
          }
        }

        const sortDate = (parsed.data as any)?.date
          ? Date.parse(String((parsed.data as any).date))
          : Date.parse(String(f.updated_at ?? f.created_at ?? ""));

        return {
          slug,
          data: (parsed.data ?? {}) as Record<string, any>,
          content: parsed.content ?? "",
          sortDate: Number.isFinite(sortDate) ? sortDate : 0,
          status,
        };
      })
  );
}

const [publishedPosts, draftPosts] = await Promise.all([
  parseFiles(publishedFiles, PUBLISHED_FOLDER, "published"),
  parseFiles(draftFiles, DRAFT_FOLDER, "draft"),
]);

const posts = [...publishedPosts, ...draftPosts].filter(Boolean);

posts.sort((a, b) => (b?.sortDate ?? 0) - (a?.sortDate ?? 0));

const { count, error: countError } = await supabase
  .from(CONTACT_TABLE)
  .select("id", { count: "exact", head: true })
  .eq("seen", false);

const unreadMsgCount = countError ? 0 : (count ?? 0);
---
<EmptyLayout pageTitle={pageTitle} accessToken={accessToken} refreshToken={refreshToken} showNav={false}>
  <div class="bg-stone-100 h-[100lvh]">
    <div class="grid gap-4 p-4 grid-cols-[220px_1fr]">
      <Sidebar page="articles" unreadMsgCount={unreadMsgCount} client:load />
      <ArticlesPage articles={posts} client:load />
    </div>
    <p class="mx-auto text-stone-400 w-fit text-sm py-1.5">
      Â© Copyright 2026. Made by Gab Savard.
    </p>
  </div>
</EmptyLayout>
