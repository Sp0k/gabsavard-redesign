---
import matter from "gray-matter";
import { supabase } from "../db/supabase.server";
import {
  BLOG_BUCKET,
  PUBLISHED_FOLDER,
  DEVLOG_POSTS,
  DEVLOG_ASSETS,
ASSETS_BUCKET,
} from "../db/storage.constants";
import BaseLayout from "../layouts/BaseLayout.astro";
import BlogPage from "../components/BlogPage";

export const prerender = false;
const pageTitle = "Blog";

const PUBLIC_SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
if (!PUBLIC_SUPABASE_URL) throw new Error("Missing PUBLIC_SUPABASE_URL");

// ---- Types ----
type PostStatusFolder = string;

type StorageListItem = {
  name: string;
  updated_at?: string | null;
  created_at?: string | null;
};

type Frontmatter = Record<string, unknown> & {
  date?: string | Date;
  tags?: string[];
  image?: {
    url?: string;
    [k: string]: unknown;
  };
};

type ParsedPost = {
  slug: string;
  data: Frontmatter;
  content: string;
  sortDate: number;
};

type FetchPostsArgs = {
  postsBucket: string;
  assetsBucket: string;
  folder: PostStatusFolder;
  limit?: number;
};

async function fetchPostsFromStorage({
  postsBucket,
  assetsBucket,
  folder,
  limit = 200,
}: FetchPostsArgs): Promise<ParsedPost[]> {
  const { data, error } = await supabase.storage
    .from(postsBucket)
    .list(folder, { limit });

  if (error) {
    console.error(error);
    return [];
  }

  const files: StorageListItem[] = (data ?? []) as StorageListItem[];

  const postsOrNull = await Promise.all(
    files
      .filter((f) => f.name.endsWith(".md"))
      .map(async (f): Promise<ParsedPost | null> => {
        const path = `${folder}/${f.name}`;

        const { data: urlData } = supabase.storage
          .from(postsBucket)
          .getPublicUrl(path);

        const publicUrl = urlData?.publicUrl;
        if (!publicUrl) return null;

        const r = await fetch(publicUrl);
        if (!r.ok) return null;

        const mdText = await r.text();

        const parsed = matter(mdText);
        const slug = f.name.replace(/\.md$/i, "");

        const fm: Frontmatter = (parsed.data ?? {}) as Frontmatter;
        fm.image = fm.image ?? {};

        const assetsBase =
          `${PUBLIC_SUPABASE_URL}/storage/v1/object/public/${assetsBucket}/${slug}/`;

        const src = (fm.image.url ?? "").trim();

        if (src) {
          const alreadyAbsolute =
            src.startsWith("http://") ||
            src.startsWith("https://") ||
            src.startsWith("data:") ||
            src.startsWith("#") ||
            src.includes("/storage/v1/object/public/");

          if (!alreadyAbsolute) {
            if (src.startsWith("/pictures/posts/")) {
              const rest = src.replace(/^\/pictures\/posts\//, "");
              fm.image.url =
                `${PUBLIC_SUPABASE_URL}/storage/v1/object/public/${assetsBucket}/${rest}`;
            } else if (src.startsWith("/")) {
              // do nothing
            } else {
              const clean = src.replace(/^\.?\//, "");
              fm.image.url = assetsBase + clean;
            }
          }
        }

        const sortDate = fm.date
          ? Date.parse(String(fm.date))
          : Date.parse(String(f.updated_at ?? f.created_at ?? ""));

        return {
          slug,
          data: fm,
          content: parsed.content ?? "",
          sortDate: Number.isFinite(sortDate) ? sortDate : 0,
        };
      })
  );

  return postsOrNull.filter((p): p is ParsedPost => p !== null);
}

// BLOG posts
const blogPosts = await fetchPostsFromStorage({
  postsBucket: BLOG_BUCKET,
  assetsBucket: ASSETS_BUCKET,
  folder: PUBLISHED_FOLDER,
});

// DEVLOG posts
const devlogPosts = await fetchPostsFromStorage({
  postsBucket: DEVLOG_POSTS,
  assetsBucket: DEVLOG_ASSETS,
  folder: PUBLISHED_FOLDER,
});

console.log(devlogPosts);

blogPosts.sort((a, b) => (b.sortDate ?? 0) - (a.sortDate ?? 0));
devlogPosts.sort((a, b) => (b.sortDate ?? 0) - (a.sortDate ?? 0));

const blogTags = [...new Set(blogPosts.flatMap((p) => p.data.tags ?? []))].sort();
const devlogTags = [...new Set(devlogPosts.flatMap((p) => p.data.tags ?? []))].sort();
---
<BaseLayout pageTitle={pageTitle}>
  <div class="mt-4">
    <h1 class="font-Nunito font-semibold text-4xl lg:text-5xl text-[#D9D9D9]">#{pageTitle}</h1>
    <p class="font-Source-Sans-Pro text-xl lg:text-2xl mt-[10px] text-[#D9D9D9] max-w-screen-2xl lg:mr-6">
      Dive into my thoughts and interests. I write down my thoughts and ideas in here and hope will
      either find them interesting or helpful.
    </p>
    <BlogPage blogPosts={blogPosts} blogTags={blogTags} devlogPosts={devlogPosts} devlogTags={devlogTags} client:load />
  </div>
</BaseLayout>
